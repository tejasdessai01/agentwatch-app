<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AgentWatch - Mission Control</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #1f2937; }
    ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
  </style>
</head>
<body class="bg-gray-900 text-white font-mono h-screen overflow-hidden flex flex-col">

  <!-- Header -->
  <header class="bg-gray-800 border-b border-gray-700 p-4 flex justify-between items-center shadow-md z-10">
    <div class="flex items-center gap-4">
      <h1 class="text-2xl font-bold text-emerald-400 tracking-wider">AGENTWATCH v2.1</h1>
      <span id="connection-status" class="text-xs text-gray-500 bg-gray-900 px-2 py-1 rounded border border-gray-700">Connecting...</span>
    </div>
    <div class="flex gap-4 text-sm">
      <button onclick="showTab('dashboard')" id="tab-dashboard" class="text-emerald-400 font-bold border-b-2 border-emerald-400 pb-1">DASHBOARD</button>
      <button onclick="showTab('setup')" id="tab-setup" class="text-gray-400 hover:text-white transition-colors pb-1">SETUP GUIDE</button>
      <button onclick="logout()" class="text-red-400 hover:text-red-300 transition-colors pb-1">LOGOUT</button>
    </div>
  </header>

  <!-- Global Analytics Bar -->
  <div id="analytics-bar" class="bg-gray-800 border-b border-gray-700 p-4 grid grid-cols-4 gap-4 text-center shadow-sm z-10 hidden">
    <div>
      <div class="text-xs text-gray-500 uppercase font-bold">Total Active</div>
      <div class="text-xl font-bold text-white" id="stat-active">0</div>
    </div>
    <div class="border-l border-gray-700">
      <div class="text-xs text-gray-500 uppercase font-bold">Total Cost</div>
      <div class="text-xl font-bold text-emerald-400" id="stat-cost">$0.00</div>
    </div>
    <div class="border-l border-gray-700">
      <div class="text-xs text-gray-500 uppercase font-bold">Total Tokens</div>
      <div class="text-xl font-bold text-blue-400" id="stat-tokens">0</div>
    </div>
    <div class="border-l border-gray-700">
      <div class="text-xs text-gray-500 uppercase font-bold">Status</div>
      <div class="text-xs font-bold text-green-400 mt-1">OPERATIONAL</div>
    </div>
  </div>

  <!-- Main Content Area -->
  <main class="flex-1 overflow-y-auto p-6 relative pb-20"> <!-- Added pb-20 for footer spacing -->
    
    <!-- DASHBOARD TAB -->
    <div id="view-dashboard" class="block h-full">
      <!-- Empty State -->
      <div id="empty-state" class="hidden h-full flex flex-col items-center justify-center text-gray-500">
        <svg class="w-16 h-16 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
        <h3 class="text-xl font-bold mb-2">No Active Agents</h3>
        <p class="mb-6">Your fleet is offline. Start an agent to see data.</p>
        <button onclick="showTab('setup')" class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-2 rounded font-bold transition-colors">Install AgentWatch SDK</button>
      </div>

      <!-- Active Agents -->
      <h3 id="label-active" class="text-sm font-bold text-gray-500 uppercase tracking-widest mb-4 hidden">Active Fleet</h3>
      <div id="agent-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-8">
        <!-- Active cards -->
      </div>

      <!-- Terminated Agents -->
      <div id="history-section" class="hidden">
        <h3 class="text-sm font-bold text-gray-500 uppercase tracking-widest mb-4 border-t border-gray-700 pt-8">History / Terminated</h3>
        <!-- Compact Grid for History -->
        <div id="agent-grid-history" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <!-- Compact cards -->
        </div>
      </div>
    </div>

    <!-- SETUP TAB -->
    <div id="view-setup" class="hidden max-w-4xl mx-auto">
      <div class="bg-gray-800 border border-gray-700 rounded-lg p-8 shadow-xl">
        <!-- Setup Guide Content (Same as before) -->
        <h2 class="text-3xl font-bold text-white mb-6">Quick Start Guide</h2>
        <div class="mb-8"><h3 class="text-lg font-bold text-emerald-400 mb-2">1. Install</h3><div class="bg-black p-4 rounded border border-gray-700 font-mono text-sm"><code class="text-green-400">npm install socket.io-client uuid</code></div></div>
        <div class="mb-8"><h3 class="text-lg font-bold text-emerald-400 mb-2">2. Your API Key</h3><div class="bg-black p-4 rounded border border-gray-700 font-mono text-sm break-all"><span id="display-api-key" class="text-yellow-400">Loading...</span></div></div>
      </div>
    </div>
  </main>

  <script>
    // --- APP LOGIC ---
    let socket;
    let agents = {};
    let apiKey = localStorage.getItem('agentwatch_api_key');

    if (!apiKey) {
      apiKey = prompt("Enter AgentWatch API Key:");
      if (apiKey) {
        localStorage.setItem('agentwatch_api_key', apiKey);
        initSocket();
      }
    } else {
      initSocket();
    }

    document.getElementById('display-api-key').textContent = apiKey || "Key Missing";

    function initSocket() {
      const serverUrl = window.location.origin;
      socket = io(serverUrl, { auth: { token: apiKey }, reconnection: true });
      const statusEl = document.getElementById('connection-status');

      socket.on('connect', () => {
        statusEl.textContent = 'Connected';
        statusEl.className = 'text-xs text-emerald-400 bg-gray-900 px-2 py-1 rounded border border-emerald-900';
      });

      socket.on('agent-update', (agent) => {
        agents[agent.id] = agent;
        updateOrMoveCard(agent); // Smart update
        updateGlobalStats();
      });

      socket.on('init', (data) => {
        agents = data;
        renderAllAgents(); // Initial full render
      });
    }

    // --- RENDER LOGIC ---

    function updateOrMoveCard(agent) {
      const isDead = (agent.status === 'killed' || agent.status === 'error');
      const targetGridId = isDead ? 'agent-grid-history' : 'agent-grid';
      const currentCard = document.getElementById(`agent-${agent.id}`);
      
      // If card exists but is in wrong grid, move it
      if (currentCard && currentCard.parentElement.id !== targetGridId) {
        currentCard.remove();
        renderCard(agent, document.getElementById(targetGridId), isDead);
      } else if (currentCard) {
        // Just update content (No Jitter!)
        updateCardContent(currentCard, agent, isDead);
      } else {
        // Create new
        renderCard(agent, document.getElementById(targetGridId), isDead);
      }
    }

    function renderCard(agent, grid, isCompact) {
      const card = document.createElement('div');
      card.id = `agent-${agent.id}`;
      // Compact vs Full styles
      if (isCompact) {
        card.className = "bg-gray-800/50 border border-gray-700/50 rounded flex justify-between items-center p-4 grayscale hover:grayscale-0 transition-all";
      } else {
        card.className = "bg-gray-800 border border-gray-700 rounded-lg shadow-lg overflow-hidden flex flex-col h-96 transition-all hover:border-emerald-500/50";
      }
      grid.appendChild(card);
      updateCardContent(card, agent, isCompact);
    }

    function updateCardContent(card, agent, isCompact) {
      // Logic for Full Card vs Compact Card HTML
      const cost = agent.metrics?.cost?.toFixed(4) || '0.0000';
      const tokens = agent.metrics?.tokens?.toLocaleString() || '0';
      
      let statusColor = 'bg-gray-500';
      if (agent.status === 'working') statusColor = 'bg-emerald-500 animate-pulse';
      if (agent.status === 'error') statusColor = 'bg-yellow-500 animate-bounce';
      if (agent.status === 'killed') statusColor = 'bg-red-600';

      if (isCompact) {
        // --- COMPACT VIEW ---
        card.innerHTML = `
          <div class="flex items-center gap-3">
             <div class="w-2 h-2 rounded-full ${statusColor}"></div>
             <div>
               <div class="font-bold text-gray-400 text-sm">${agent.name}</div>
               <div class="text-[10px] text-gray-600 font-mono">${agent.id}</div>
             </div>
          </div>
          <div class="text-right text-xs font-mono text-gray-500">
             <div>$${cost}</div>
             <div>${tokens} toks</div>
          </div>
        `;
      } else {
        // --- FULL VIEW ---
        const logsHtml = agent.logs.slice().reverse().map(l => 
          `<div class="mb-1 text-xs text-gray-300 font-mono border-l-2 border-gray-700 pl-2">
             <span class="text-gray-500">[${new Date(l.timestamp).toLocaleTimeString()}]</span> ${l.message}
           </div>`
        ).join('');

        card.innerHTML = `
          <div class="p-4 bg-gray-800 border-b border-gray-700 flex justify-between items-center">
            <div>
              <h3 class="font-bold text-white truncate w-40" title="${agent.name}">${agent.name}</h3>
              <div class="text-xs text-gray-500 font-mono truncate w-40">${agent.id}</div>
            </div>
            <div class="w-3 h-3 rounded-full ${statusColor} status-dot"></div>
          </div>
          <div class="grid grid-cols-3 gap-1 bg-gray-900 border-b border-gray-700 p-2 text-center">
            <div><div class="text-[10px] text-gray-500 uppercase font-bold">COST</div><div class="text-sm font-mono text-emerald-400">$${cost}</div></div>
            <div class="border-l border-gray-800"><div class="text-[10px] text-gray-500 uppercase font-bold">TOKENS</div><div class="text-sm font-mono text-blue-400">${tokens}</div></div>
            <div class="border-l border-gray-800"><div class="text-[10px] text-gray-500 uppercase font-bold">STATUS</div><div class="text-sm font-mono text-gray-400 uppercase">${agent.status}</div></div>
          </div>
          <div class="flex-1 bg-black p-4 overflow-y-auto scrollbar-thin">
            ${logsHtml || '<div class="text-gray-600 text-sm italic">Waiting for logs...</div>'}
          </div>
        <div class="p-3 bg-gray-800 border-t border-gray-700 flex justify-between items-center">
          <span class="text-xs text-gray-400 uppercase font-bold tracking-wider">${agent.status}</span>
          ${agent.status !== 'killed' ? 
            `<button onclick="killAgent('${agent.id}')" class="bg-red-900/80 hover:bg-red-600 text-white text-xs px-3 py-1 rounded font-bold transition-colors">KILL</button>` : 
            `<span class="text-red-500 text-xs font-bold">TERMINATED</span>`
          }
        </div>
        `;
      }
    }

    function updateGlobalStats() {
      let totalCost = 0;
      let totalTokens = 0;
      let activeCount = 0;
      let deadCount = 0;

      Object.values(agents).forEach(agent => {
        totalCost += agent.metrics?.cost || 0;
        totalTokens += agent.metrics?.tokens || 0;
        if (agent.status !== 'killed' && agent.status !== 'error') activeCount++;
        else deadCount++;
      });

      document.getElementById('stat-active').textContent = activeCount;
      document.getElementById('stat-cost').textContent = '$' + totalCost.toFixed(4);
      document.getElementById('stat-tokens').textContent = totalTokens.toLocaleString();

      // UI Visibility
      const hasAgents = Object.keys(agents).length > 0;
      const historySection = document.getElementById('history-section');
      
      if (hasAgents) {
        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('analytics-bar').classList.remove('hidden');
        document.getElementById('label-active').classList.remove('hidden');
      }
      
      if (deadCount > 0) historySection.classList.remove('hidden');
      else historySection.classList.add('hidden');
    }

    function renderAllAgents() {
      document.getElementById('agent-grid').innerHTML = '';
      document.getElementById('agent-grid-history').innerHTML = '';
      Object.values(agents).forEach(updateOrMoveCard);
      updateGlobalStats();
    }

    // Helper functions
    window.showTab = (tabName) => {
      ['dashboard', 'setup'].forEach(t => {
        document.getElementById(`view-${t}`).classList.add('hidden');
        document.getElementById(`tab-${t}`).classList.remove('text-emerald-400', 'border-b-2', 'border-emerald-400');
        document.getElementById(`tab-${t}`).classList.add('text-gray-400');
      });
      document.getElementById(`view-${tabName}`).classList.remove('hidden');
      document.getElementById(`tab-${tabName}`).classList.add('text-emerald-400', 'border-b-2', 'border-emerald-400');
      document.getElementById(`tab-${tabName}`).classList.remove('text-gray-400');
    };
    window.logout = () => { localStorage.removeItem('agentwatch_api_key'); window.location.reload(); };
    window.killAgent = (id) => { if (confirm(`Terminate agent ${id}?`)) socket.emit('kill-agent', id); };
    window.copyToClipboard = (text) => { navigator.clipboard.writeText(text); alert("Copied!"); };
  </script>
</body>
</html>
